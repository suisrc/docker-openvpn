#!/bin/bash

# ENV VPN_TYPE= openvpn\

clean_skip_ips() {
  if [[ -n "$SKIPPED_IPS" ]]; then
      # echo "skipped ips: $SKIPPED_IPS"
      default_gw=$(ip route show | grep via | awk '{print $3}')
      IFS=',' read -ra skip_ips <<< "$SKIPPED_IPS"
      for skip_ip in "${skip_ips[@]}"; do
          echo "[-] ip route del $skip_ip via $default_gw"
          ip route del "$skip_ip" via "$default_gw"
      done
  fi
}

if [[ $VPN_TYPE == *openvpn ]]; then
    echo "cleaning openvpn..."
    # clean_skip_ips
    kill TERM `pgrep openvpn`
elif [[ $VPN_TYPE == *wireguard ]]; then
    echo "cleaning wireguard..."
    clean_skip_ips
    wg-quick down wg0
else 
    echo "unknown vpn: $VPN_TYPE"
fi

if [[ -n "$EXIT_SHELL" ]]; then
  echo "exit shell: $EXIT_SHELL"
  bash -c "$EXIT_SHELL"
fi

# VPN_TYPE=surfshark-openvpn bash ./bin/vpn-stop