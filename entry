#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

# 执行配置脚本，在启动前执行
if [[ -n "$WG_CONF_SHELL" ]]; then
    echo "create conf by shell: $WG_CONF_SHELL"
    eval "$WG_CONF_SHELL"
fi

# 启动wireguard
wg-quick up wg0
if [[ ! -e /sys/class/net/wg0 ]]; then
    echo "wg0 not found, wireguard up failed."
    exit 1
fi

# 显示连接状况
# sleep 1 && wg show
echo "" && echo "wg0 is up"

# trap cleanup TERM
# if [ ! -e /pause ]; then mkfifo /pause; fi
# </pause # 中断

# inotifywait -m /path/to/watched/directory
# modify,move,create,delete
inotifywait -e create -mr --timefmt '%d/%m/%y %H:%M:%S' --format '%T' /etc/wireguard/ | while read date time; do
    echo "At ${time} on ${date}, config file update detected."
    if [[ ! -e /sys/class/net/wg0 ]]; then
        echo "wg0 not found, wireguard down."
        exit 1
    fi
    # 重载wireguard配置
    wg syncconf wg0 <(wg-quick strip wg0)
    # sleep 1 && wg show
done

# cleanup...
wg-quick down wg0
echo "wg0 is down"
